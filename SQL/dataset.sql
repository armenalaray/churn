SET
	SEARCH_PATH TO SOCIALNET7;

WITH
	PARAMS AS (
		SELECT
			INTERVAL '7 day' AS METRIC_PERIOD,
			'2020-02-09'::TIMESTAMP AS OBS_START,
			'2020-05-10'::TIMESTAMP AS OBS_END
	)
SELECT
	M.ACCOUNT_ID,
	O.OBSERVATION_DATE,
	IS_CHURN,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 0 THEN METRIC_VALUE
			ELSE 0
		END
	) AS LIKE_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 1 THEN METRIC_VALUE
			ELSE 0
		END
	) AS NEWFRIEND_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 2 THEN METRIC_VALUE
			ELSE 0
		END
	) AS POST_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 3 THEN METRIC_VALUE
			ELSE 0
		END
	) AS ADVIEW_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 4 THEN METRIC_VALUE
			ELSE 0
		END
	) AS DISLIKE_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 5 THEN METRIC_VALUE
			ELSE 0
		END
	) AS UNFRIEND_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 6 THEN METRIC_VALUE
			ELSE 0
		END
	) AS MESSAGE_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 7 THEN METRIC_VALUE
			ELSE 0
		END
	) AS REPLY_PER_MONTH,
	SUM(
		CASE
			WHEN METRIC_NAME_ID = 8 THEN METRIC_VALUE
			ELSE 0
		END
	) AS ACCOUNT_TENURE
FROM
	METRIC M
	INNER JOIN PARAMS ON METRIC_TIME BETWEEN OBS_START AND OBS_END
	INNER JOIN OBSERVATION O ON M.ACCOUNT_ID = O.ACCOUNT_ID
	AND M.METRIC_TIME > (O.OBSERVATION_DATE - METRIC_PERIOD)::TIMESTAMP
	AND M.METRIC_TIME <= O.OBSERVATION_DATE::TIMESTAMP
GROUP BY
	M.ACCOUNT_ID,
	O.OBSERVATION_DATE,
	--metric_time,
	IS_CHURN
ORDER BY
	O.OBSERVATION_DATE,
	M.ACCOUNT_ID